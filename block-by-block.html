<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Block by Block â€“ Full Version</title>
</head>
<body>
<h1>ðŸŽµ Block by Block â€“ Full Version</h1>
<button onclick="playSong()">Play Song</button>

<script>
const NOTES = {
  "C4":261.63,"D4":293.66,"E4":329.63,"F4":349.23,"G4":392.00,"A4":440.00,"B4":493.88,
  "C3":130.81,"D3":146.83,"E3":164.81,"F3":174.61,"G3":196.00,"A3":220.00,"B3":246.94,
  "REST":0
};

const CHORDS = {
  "C":["C4","E4","G4"],
  "F":["F4","A4","C4"],
  "G":["G4","B4","D4"],
  "Am":["A4","C4","E4"]
};

// Original melody section
const song = [
  ["C4","C","C3",0.5],["C4","C","C3",0.5],["E4","C","C3",0.5],["G4","C","C3",0.5],
  ["G4","F","F3",0.5],["E4","F","F3",0.5],["D4","G","G3",0.5],["C4","G","G3",0.5],
  ["E4","Am","A3",0.5],["E4","Am","A3",0.5],["G4","F","F3",0.5],["A4","F","F3",0.5],
  ["G4","C","C3",0.5],["E4","C","C3",0.5],["D4","G","G3",0.5],["C4","G","G3",1.0]
];

// Extra sections
const intro = [
  ["E4","C","C3",0.5],["G4","C","C3",0.5],["A4","F","F3",0.5],["G4","F","F3",0.5]
];
const bridge = [
  ["A4","Am","A3",0.5],["G4","F","F3",0.5],["E4","G","G3",0.5],["F4","C","C3",0.5]
];
const outro = [
  ["C4","C","C3",0.5],["E4","C","C3",0.5],["G4","C","C3",1.0]
];

// Play a pitched tone
function playTone(ctx, freq, dur, start, type="sine", vol=0.2) {
  if (freq===0) return;
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.type = type;
  osc.frequency.value = freq;
  osc.connect(gain);
  gain.connect(ctx.destination);

  // Smooth envelope
  gain.gain.setValueAtTime(0, start);
  gain.gain.linearRampToValueAtTime(vol, start+0.02);
  gain.gain.linearRampToValueAtTime(vol*0.8, start+dur);
  gain.gain.linearRampToValueAtTime(0, start+dur+0.05);

  osc.start(start);
  osc.stop(start+dur+0.05);
}

// Simple drum sounds
function playDrum(ctx, type, start, vol=0.3) {
  const osc = ctx.createOscillator();
  const gain = ctx.createGain();
  osc.connect(gain);
  gain.connect(ctx.destination);

  if (type === "kick") {
    osc.type = "sine";
    osc.frequency.setValueAtTime(150, start);
    osc.frequency.exponentialRampToValueAtTime(50, start + 0.15);
  } else if (type === "snare") {
    osc.type = "triangle";
    osc.frequency.setValueAtTime(200, start);
  } else if (type === "hihat") {
    osc.type = "square";
    osc.frequency.setValueAtTime(400, start);
  }

  gain.gain.setValueAtTime(vol, start);
  gain.gain.exponentialRampToValueAtTime(0.001, start + 0.1);

  osc.start(start);
  osc.stop(start + 0.1);
}

function playSection(ctx, section, dynamics=1.0, t) {
  section.forEach(([mel, chord, bass, dur], i) => {
    // Melody
    playTone(ctx, NOTES[mel], dur, t, "sine", 0.3*dynamics);
    // Chords
    CHORDS[chord].forEach(n => playTone(ctx, NOTES[n], dur, t, "triangle", 0.15*dynamics));
    // Bass
    playTone(ctx, NOTES[bass], dur, t, "square", 0.2*dynamics);

    // Beat every half-beat
    playDrum(ctx, "hihat", t, 0.12*dynamics);
    if (i % 2 === 0) {
      playDrum(ctx, "kick", t, 0.3*dynamics);
    } else {
      playDrum(ctx, "snare", t, 0.25*dynamics);
    }

    t += dur;
  });
  return t;
}

function playSong() {
  const ctx = new (window.AudioContext || window.webkitAudioContext)();
  let t = ctx.currentTime + 0.1;

  // Intro (soft)
  t = playSection(ctx, intro, 0.6, t);
  // Main song (medium)
  t = playSection(ctx, song, 0.8, t);
  // Bridge (dip)
  t = playSection(ctx, bridge, 0.7, t);
  // Main song again (full)
  t = playSection(ctx, song, 1.0, t);
  // Outro (fade)
  t = playSection(ctx, outro, 0.5, t);
}
</script>
</body>
</html>
